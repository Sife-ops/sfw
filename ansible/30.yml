---
- name: prepare sfw repository
  hosts: sfw_manager:sfw_node
  remote_user: sfw
  # gather_facts: no
  vars:
    manager_wgip: "{{ hostvars[groups['sfw_manager'][0]].wgip }}"
  tasks:

    # - name: asdf
    #   debug:
    #     var: inventory_hostname
    # - name: asdf
    #   meta: end_play

    - name: create user bin path
      ansible.builtin.file:
        path: /home/sfw/.local/bin
        state: directory

    - name: stat pkl binary
      ansible.builtin.stat:
        path: /home/sfw/.local/bin/pkl
      register: pkl_bin

    - name: download pkl binary
      ansible.builtin.get_url:
        url: https://github.com/apple/pkl/releases/download/0.25.2/pkl-linux-amd64
        dest: /home/sfw/.local/bin/pkl
        mode: '0755'
      when: not pkl_bin.stat.exists

    - name: install pkl-gen-go
      ansible.builtin.shell: 
        cmd: "PATH=$PATH:/usr/local/go/bin go install github.com/apple/pkl-go/cmd/pkl-gen-go@latest"

    # todo this doesnt work for ansible tasks
    - name: add sfw bin to path
      remote_user: root
      ansible.builtin.blockinfile:
        path: /etc/profile
        marker: "# {mark} sfw bin {{ inventory_hostname }}"
        block: |
          PATH=$PATH:/home/sfw/.local/bin:/home/sfw/go/bin

    - name: clone sfw
      ansible.builtin.git:
        repo: https://github.com/Sife-ops/sfw.git
        dest: /home/sfw/sfw
        recursive: yes
        update: true

    - name: configure sfw
      ansible.builtin.blockinfile:
        path: "/home/sfw/sfw/pkl/amends.pkl"
        create: true
        marker: "// {mark} amends {{ inventory_hostname }}"
        block: |
          amends "./config.pkl"

          wgip = "{{ hostvars[inventory_hostname].wgip }}"

          postgres {
              host = "{{ manager_wgip }}:5432"
              database = "seed"
              username = "seed"
              password = ""
          }

          log {
              host = "{{ manager_wgip }}:1337"
          }

          web {
              host = "127.0.0.1:3000"
          }

          worldgen {
              ravine_proximity = 4
          }